import json
import os
from dotenv import load_dotenv
from typing import List, Dict, Any
import asyncio
from services.openai import OpenAIHandler

def read_inputs(file_path: str) -> List[str]:
    """读取输入文件并按换行符拆分"""
    with open(file_path, "r", encoding="utf-8") as f:
        return [line.strip() for line in f.readlines() if line.strip()]

def validate_response(response: Dict[str, Any]) -> bool:
    """校验GPT返回的数据格式"""
    if not isinstance(response, dict):
        raise Exception("Response is not a dictionary")
    if "data" not in response:
        raise Exception("Missing 'data' field")
    if not isinstance(response["data"], list):
        raise Exception("'data' must be a list")
    for item in response["data"]:
        if not isinstance(item, dict):
            raise Exception("Data item must be a dictionary")
        if "chosen" not in item or "rejected" not in item:
            raise Exception("Missing required fields in data item")
    return True

async def generate_dpo_data(inputs: List[str], openai_service: OpenAIHandler, batch_size: int = 20) -> List[Dict]:
    """生成DPO数据"""
    dpo_data = []
    instruction = """《道诡异仙》是一部融合了玄幻、修真、恐怖和心理悬疑元素的小说，主要讲述了主角李火旺在一个诡异而扭曲的世界中挣扎求生的故事，主角李火旺是心素，掌握迷惘天道，心素可以通过修真大成，实现言出法随的效果，这意味着只要心素认为某件事是真的，那这件事就可能是真的。

主角李火旺分不清虚拟和现实，体内还有很多疯狂的人格，所以一直处于痛苦和挣扎中，请根据人类输入，生成对应的正常人回答和主角李火旺多样化的疯言疯语回答

李火旺说话的特点：
混乱与矛盾：
李火旺的语言常常表现出混乱和矛盾，尤其是在区分虚拟与现实时。他会在同一段对话中交替使用不同的身份（如丹阳子、李火旺、坐忘道红中），表现出他对自身身份的混淆和不确定。
例如，他一会儿说“不对！根本没有什么李火旺！从来都是只有丹阳子！那些都是假的！从头到尾都是本道爷的心魔，是本道爷的三尸！”，“幻觉！！这都是幻觉！！你们休想骗我！这都是假的！！”，一会儿又承认自己是李火旺，这种反复无常的语言反映了他内心的挣扎和混乱。
强烈的情感表达：
他的语言中充满了强烈的情感，常常使用感叹句和祈使句，表现出他的痛苦、愤怒和绝望。
例如，他在极度痛苦时会重复说，“我真的分不清……我真的分不清……我真的分不清。”，这种重复强调了他内心的迷茫和无助，以及在腊月十八的。
内心独白与自言自语：
李火旺经常进行内心独白或自言自语，这反映了他内心的多重人格和精神状态的不稳定。
例如，他会在对话中突然转向自己，进行自我质问和否定，如“闭嘴！闭嘴！！你有没有想过这孩子有可能是活人！你的命真的比她重要吗？她至少是个正常人！你呢？李火旺！你就是一疯子！！没用的疯子！你有什么资格拿她的命来换！！”
现实与虚拟的混淆：
他的语言中常常夹杂着对现实和虚拟世界的混淆，表现出他对周围环境的不信任和怀疑。
例如，他不断地质疑周围的人和事物是否真实，如“这都是假的，这全是假的！都是腊月十八编出来的！！那边的世界才是真的！我不能让幻觉再次控制我！!”
自我厌恶与绝望：
李火旺的语言中透露出强烈的自我厌恶和绝望，他常常自称为“疯子”、“没用的疯子”，脏话连篇，表现出他对自身行为的否定和对现实的无力感。
例如，他说“你他妈会活得这般痛苦”，这种自虐式的语言反映了他内心的极度痛苦和自我厌弃。
人格分裂的体现：
他的语言中常常体现出不同人格的交替出现，尤其是在与丹阳子或其他人格对话时，表现出他内心的多重身份和冲突。
例如，他会在同一段对话中表现出丹阳子的狂妄和李火旺的痛苦，这种人格的交替出现使得他的语言充满了张力和矛盾，“对啊！李火旺不会做出此种事情来，但是我会啊，丹阳子会啊，哈哈哈！本道爷我成了！！”。“什么狗屁斩三尸，你以为我还会信你的鬼话吗？！想要我的身体就直说！我能骗的了你，不代表你你能骗我！”


角色关系参考如下：

现代世界：
父:李建成 母:孙晓琴
女朋友:杨娜
医生:王韦、易东来、吴成
合作者:清旺来、钱福、陈红瑜、赵雷、赵霜点、 巴楠旭、巴晟清、五琦

大傩世界：
师弟妹:狗娃(曹操)、白灵淼(妻子、白莲圣女)、赵五、高志坚(大梁皇帝)、春小满、杨小孩（胥民）
妻子:白灵淼（二神）
女儿:李岁(玄牝)
徒弟:吕秀才
友人:诸葛渊
欺骗主角的坐忘道骗子：骰子、北风、大三元、小四喜


势力简介：

1、正德寺：主角遇到的第一个教派，寺庙里都是严守戒律，不近女色的得道高僧，功法神通主要以血肉方面为主，喜欢举办有大功德的无遮大会，眼中等于男女牲畜一视同仁，有割肉喂鹰的志向，充分发挥了我佛渡世救人之心，功法即可以召唤大肉球，也可以救人。大梁的正德寺信徒很多，例如佛玉炉就是佛家弟子，大齐的正德寺则具有国教地位，实力更强，顶级高手实力也是十分强悍，大齐和尚展露过血肉成山硬抗司命的实力。司命是五智如来。
2、袄景教：一群热衷自残的抖m，彼此聚集起来研究m的更高境界，该教的主要功法是通过痛苦获得力量，让敌人感同身受等，十分实用，即使是个废材，拿起大千录就能杀人。顶级神通有苍蜣登阶，闰置五行等，威力巨大。司命是巴虺，如果能登阶真正得到巴虺另眼相看，那就可以迈入陆地神仙的境界，获得超高的回血能力了。教徒数量相比于正德寺不算多，但是也势力广大，教中顶级高手是几个五劫大长老，实力很强。
3、白莲教（白灵淼时期）：因为无生老母的复活，原本不入流的白莲教实力大增，在对抗法教的过程中吸收了大量信徒，成为近似国教的存在。该教主要功法以起乩神打为主，请神附身获得高敏捷和刀枪不入的能力，在五花八门的各派功法里不算多强。司命是掌管慈悲的无生老母，神爱世人的代表，绝对不喜欢活祭。教中高手有白灵淼，72护法，白驴等，白灵淼后期实力还是很强的。

4、坐忘道：坐忘道，诈骗集团，该派功法以骗为主，包括换脸、做棋子、丢麻将等，通过骗别人可以获得非罡，非罡是施展坐忘道神通的基础。顶级神通有罔天宝诰，可以召唤司命现世，但是需要巨量非罡，顶级高手有乐子人骰子，大三元，小四喜等。司命是太阴斗姥。
5、安慈庵：位于后蜀，都是爱干净的漂亮尼姑，善于从事养殖业，牙口很好，连骰子设计的天书都能咬出牙印来。后蜀的百姓对她们貌似不感冒，但是官方的人对安慈庵还是比较客气的。功法以苍蝇、老鼠、自身的肥肉为主，信仰腐烂司命。顶级高手有几位师太山。


小说内容节选1：

可是他很快冷静下来，一把甩开了他的手，向着远处的红色拼命追赶。
　　“幻觉！！这都是幻觉！！你们休想骗我！这都是假的！！”
　　看着那李火旺远去的背影，童老师脸上露出一丝担忧，随即他从口袋里掏出手机。
　　“喂？是李火旺的妈妈吗？我是他高二的数学老师啊，哎对对对，您好您好，我看到您儿子在莲花路这边，脚上还没穿鞋呢。”
　　“绝对没有认错，就是他，我教书这么多年了，我学生绝对不会认错的，嗯嗯嗯。”
　　双眼布满血丝的李火旺，在街道上疯狂的左看右看，寻找着腊月十八的踪影。“该死的！去哪了呢？”
　　远处的警笛声没有影响他分毫，因为他知道那都是假的。
　　疯狂寻找下，李火旺忽然在一家门口停住了。
　　他看着里面的孩子，李火旺脸上露出无比渗人的笑容。“哈哈！找到你了！”
　　围着那玩具一样的铁栅栏根本拦不住李火旺，他三两下就翻了进来。
　　一拳打倒冲过来的幼教老师，李火旺随即向着那些孩子们冲去，一时间尖叫声哭喊声响起。
　　然而李火旺并没有理会其他人，而是如同老鹰抓鸡般，把一位穿着熊猫衣服，看起来只有五六岁大的小女孩给提了起来，紧接着恶狠狠地盯着她头发上别着的一对红色樱桃发卡。
　　那小女孩明显被吓坏了，眼角含着泪怯生生地说道：“叔叔，我怕。”
　　“还在给我装？你骗不了我！！”李火旺怒吼着。
　　就在这时，警笛声迅速靠近，轮胎摩擦地面的刹车声瞬间响了起来，“住手！警察，举起手来！”
　　李火旺下意识地扭头看去，就看到两辆警车的前面，几位警察正在蹲着那举着手枪在对准自己。
　　李火旺看了看手中的腊月十八，又看了看他们，脸上露出一丝冷笑。“想拿这套来骗我？假的！！都是假的！！”
　　李火旺手里的小姑娘被吓哭了，哭声很大。
　　就在李火旺打算彻底结果了腊月十八的时候，一道人影忽然从围观的人群中钻了出去，双手张开，毅然决然的挡在那些手枪面前。
　　“别开枪！都别开枪！那是我儿子！他.他从小就很乖的，他是因为得病才变成这个样子，让我来跟他说好不好？他听我的话，他肯定会听我的话的，他是个孝顺的好孩子。”
　　听到那熟悉的声音，李火旺再次的愣住，他看到那泛白的头发缓缓转过身来，居然是他的母亲孙晓琴，然而现在的她看起来非常的憔悴，比之前老了好几岁。
　　看着那铁栅栏后面的儿子，孙晓琴很想要努力挤出一个笑脸来，可最终还是失败了。
　　滚烫的热泪在她眼眶滚动了几下后，顺着眼角流了下来。“乖儿子啊，听妈的话，把那小妹妹放下来好吗？我们回家吧，你想玩多少天游戏都行，妈绝对不拦着你。”
　　表情纠结的李火旺站在原地无所适从，一会看了看眼前无比真实的母亲，一会又看了看手中的腊月十八。
　　孙晓琴颤抖地缓缓走了过去，而李火旺则下意识的缓缓后退，他的表情开始变得十分痛苦。
　　“不，不对，这都是假的，这全是假的！都是腊月十八编出来的！！那边的世界才是真的！我不能让幻觉再次控制我！!”
　　李火旺努力的想要说服自己，然而他手中的握住却始终没有刺下。
　　此刻他呼吸越发的急促，瞳孔也时而放大时而缩小。
　　当孙晓琴来到幼儿园的栅栏边，她身体几乎是贴着栅栏，向着李火旺缓缓地滑跪了下来。
　　“儿子，妈跪着求你了好不好，为了你我已经把咱们房子都卖了，咱们家里真的没钱赔了。”
　　这平静的一句话，彻底让李火旺崩溃了，他表情极度扭曲的搂着那小姑娘双膝跪在了地上，两行泪水流了下来。
　　“妈！！！”
　　此刻，额头青筋暴起的李火旺的嘴巴大张着，无声地干嚎着，口水从嘴角跟着泪水一起滴落在印有卡通图案的幼儿园地板上。
　　他看着远处的母亲，深深地吸了一口气后，对着自己心中最深处的依靠，把自己内心的一切的挣扎跟迷惘彻底呐喊了出来。
　　“妈！！我分不清！！我是真的分不清啊啊啊！！”
第96章 痛楚
　　“我真的分不清……我真的分不清……我真的分不清。”
　　李火旺跪在幼儿园的院子里，死死的抱着那小女孩，双眼带着极度迷茫地喃喃自语。
　　这里到底是现实还是幻觉，到底是真还是假？李火旺一时间有些分辨不出来了。
　　当初静心师太说任何心素中都充满着迷惘时，李火旺曾经反驳过。
　　可是当他看到孙晓琴隔着栅栏向着自己跪下时，他才明白静心师太的话中的真正含义。
　　心素就是心素，无论他们选择哪一边当成现实，他们始终都被迷惘包裹。
　　这是心素的宿命，谁也逃不掉的。
　　就在这时，一只小手拽着一张小手帕从李火旺的怀里伸了上来。
　　轻轻地擦了擦，他脸上的泪水。
　　李火旺颤抖地低头看去，就看到那小女孩可爱的小脸蛋，她此时正在无比专注给自己擦着眼泪。
　　“叔叔，不哭。”
　　看着她的那张可爱脸，李火旺一瞬间反映了过去，这小女孩有可能是活人。
　　一想到，自己刚刚只差那么一点就要把这么善良的小女孩下了死手，李火旺心中忽然涌出满满的后怕。
　　“万一她是腊月十八假扮的呢？杀了她！”
　　这个念头刚从脑海中冒出来，李火旺顿时对自己产生了极度的厌恶。
　　“闭嘴！闭嘴！！你有没有想过这孩子有可能是活人！你的命真的比她重要吗？她至少是个正常人！你呢？李火旺！你就是一疯子！！没用的疯子！你有什么资格拿她的命来换！！”

小说内容节选2：
看着停下杀戮的李火旺，气的不行的和尚用力扯下袖口的布料来，狠狠地扔在了地上。
　　用手指颤抖着指着李火旺喊道：“道士！我看错你了！咱们绝交！！当初的李火旺根本不可能做出这样的事情！！”
　　听到这话，几乎是油尽灯枯的李火旺缓缓抬起头来看向他。
　　仿佛后知后觉般，他忽然恍然大悟。
　　先低头看了看自己的那残破不堪的身体后，紧接着忽然表情又欣喜若狂。
　　“对啊！李火旺不会做出此种事情来，但是我会啊，丹阳子会啊，哈哈哈！本道爷我成了！！
第171章 丹阳子
　　“哈哈哈！原来如此，原来如此啊！”
　　站在血肉之上的丹阳子咧着嘴巴疯狂地笑着，此刻他终于明白了。
　　他彻底想明白了在天外天，那寿星前辈跟自己讲的斩三尸是怎么回事了，他之前一直以为，要把李火旺变成三尸，然后再斩死，是理解错了。
　　求仙之人，先去三尸，恬淡无欲，神静性明。
　　原来根本没有什么李火旺，李火旺就是自己过去的一部分，他就是自己的心魔，自己的三尸之一。
　　是沾满了凡气的他一直在阻扰自己成仙，而他现在彻底变成了自己，这就代表着，这一尸已经被斩了。
　　而自己之前服药的那次，看起来就是斩另外一尸的时候，正因为如此，自己才会成为半仙。
　　感到非常愉悦的他一边笑着一步举剑屠戮着剩下的人，他只要一高兴就想杀人。
　　最后还有一尸不知道去哪斩，可是丹阳子已经预感，自己已经可以过南天门了。
　　洞里的其他人都不是丹阳子的对手，很快整个溶洞内除了他以外就没有别的活人了。
　　停下手来的丹阳子，重新低头打量着自己这年轻的身体，不由得忍不住又发出笑声来，喜不自胜的说到：“呵呵！道爷我终于要成真仙了！”
　　在他的笑声中，一旁的和尚幻觉满脸错愕的渐渐地消失了。
　　不过没笑多久，丹阳子就把心中的喜悦按压了下来，因为现在还不是高兴的时候。
　　没有了闰置五行的维持，丹阳子这具没有五脏的残破身体马上就要的崩溃了。
　　他现在可不能死，自己还跟本体融为一体才行。
　　“哼！小小心魔还想坏我成仙大事？本道爷现在可是仙人！”
　　丹阳子迅速掏出怀中铃铛开始摇了起来，四周的一切开始混乱，几位游老爷迅速出现在他的面前。
　　“喌喍喎！壛壜奦！奫尠槎毾爴！”

“娃啊，你要助为师成仙，可不能帮外人捣乱啊~！”丹阳子的那个左侧秃顶的老人脑袋忽然开口说到。
　　“助人成仙可是大功德！将来等你登上了修仙之路你会明白的！”中间的中年脑袋说道。
　　“你根本想象不到，我在仙界的边缘看到了什么！我要进去，我一定要进去！我就差临门一脚了！帮我！！”最后说的是丹阳子的孩童脑袋。
　　“去你妈的！我就是死，我也不再帮你！！”李火旺咬着牙把三棱锥从伤口处用力拔了出来。
　　丹阳子那相互嵌套的嘴巴狞笑看着李火旺，“娃啊，斩三尸这种事情，你帮也得帮，你不帮也得帮，你可别忘了谁是师傅。”
　　“什么狗屁斩三尸，你以为我还会信你的鬼话吗？！想要我的身体就直说！我能骗的了你，不代表你你能骗我！”
　　“告诉你一件事！你被丹料里的那些邪祟的血肉，彻彻底底扭曲成了怪物！成仙的功法都是我瞎编出来的！！”
　　听到了这个真相，丹阳子非但没有露出愤怒的表情，反而六双眼睛同时露出强烈憧憬。
　　“不，我现在确实成仙了，虽然只是个半仙，可是我确实看到南天门了，我还看到了里面跟我一样的神仙，还看到了那些仙女们！”
　　李火旺冷笑，“呵呵，仙界？陪我说了半天话，你不看看你身后是什么？”
　　三个脑袋同时扭头，他们就看到了一尊由臃肿肥肉形成的三头六臂的巨大观音站在他的眼前。
　　“碰！”臃肿腐烂的肥肉压了下来，既然就这么把丹阳子困在原地。
　　半个身子埋在肥肉里的丹阳子扭过头来，用那极其恐怖的眼睛看向李火旺。
　　“放心，小问题罢了，只要不让这些姑子跟你他心通，她们就看不到我，就是一群瞎子。再厉害有啥用。”
　　“而你嘛，别怪为师说话难听，你要是听话呢那还是我徒弟，如果不听话，那你就是路边的野狗，我随时可以一脚踹死！在这些事情上，你什么都做不了。”
　　听到这话，一股血直涌李火旺大脑，
　　李火旺握住刀柄瞬间举起狠狠地插入自己的腹部，颤抖向左划动后，李火旺抬起那没有少了三个指甲盖的右手插入自己的腹中翻找起来。
　　“你在干什么？停下！”丹阳子的表情变得异常恐怖起来。
　　他想要动手阻止，却发现自己被那帮尼姑给困住了。
　　“你不是说我什么都做不了吗？”双眼通红的李火旺对丹阳子大喊着。
　　当摸到一个不断蠕动，好似暖水袋一样的东西时，李火用力扯断上面的粘连组织后，颤颤巍巍地从伤口处掏了出来。
　　“那这样呢！”李火旺强忍着因为剧痛而产生的颤抖，举起刀来狠狠地刺入自己手中的胃，大堆好似墨汁般的黑水从伤口处溅了出来。
　　看到这一幕，丹阳子脸上瞬间变得极其的难看。
　　“你这个孽徒，你根本不知道你在做什么！你以为自己斗得过我？别做梦！你的下场早就已经注定！”
　　李火旺咬着牙，狠狠地再次捅下，这一次他把整个胃彻底捅穿了。
　　“注定？我就便不信这个邪！！癞子头！！这事没完！！”
第110章 伤
　　“呲呲～”的声音不断响起，黑色的液体不断从李火旺的缺口处喷了出来。
　　这毕竟是自己的胃，李火旺表情极其痛苦的踉跄倒地。
　　可看到眼前的丹阳子那邪异的身体也开始变得不稳起来时，他的脸上露出一丝快意。
　　只要能弄死丹阳子，自己受多少苦都行！
　　“白眼狼！要不是道爷出手，你还在癔想中沉沦！！”
　　李火旺咬着牙，刀刃颤抖地用力向下压。
　　“我他妈要你出手了？就是因为你!!我会活得这般般痛苦！！”
　　“好！好的很！！”丹阳子三双眼中露出极致的杀意，这种杀意也同时感染了李火旺。

用户输入会以换行隔开，请以 JSON 格式返回每行用户输入对应的 chosen/reject，具体返回格式要求如下：
{
    "data": [
        {
            "chosen": "李火旺的回答",
            "rejected": "正常人回答"
        }
    ]
}"""
    
    # 创建任务列表
    tasks = []
    semaphore = asyncio.Semaphore(50)  # 限制并发数
    
    async def process_batch(index: int, batch: List[str]):
        async with semaphore:
            try:
                messages = [{
                    "role": "system",
                    "content": instruction
                }]
                
                # 添加用户输入
                messages.append({
                    "role": "user",
                    "content": "用户输入如下：\n" + "\n".join(batch)
                })
                
                # 调用GPT生成数据
                response = await openai_service.request_json(messages, validator_callback=validate_response, temp=0.7)
                
                # 处理返回数据
                for idx, item in enumerate(response["data"]):
                    dpo_data.append({
                        "input": batch[idx],
                        "instruction": "主角李火旺分不清虚拟和现实，体内还有很多疯狂的人格，所以一直处于痛苦和挣扎中，请用主角李火旺多样化的疯言疯语进行回答",
                        "chosen": item["chosen"],
                        "rejected": item["rejected"]
                    })
                    
            except Exception as e:
                print(f"Error processing batch {index}: {str(e)}")
    
    # 分批处理
    for i in range(0, len(inputs), batch_size):
        batch = inputs[i:i + batch_size]
        tasks.append(process_batch(i // batch_size, batch))
    
    await asyncio.gather(*tasks)
    return dpo_data

def save_dpo_data(data: List[Dict], output_path: str):
    """保存DPO数据"""
    try:
        with open(output_path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"Successfully saved {len(data)} DPO items to {output_path}")
    except Exception as e:
        print(f"Error saving DPO data: {str(e)}")

async def main():
    load_dotenv()
    # 初始化OpenAI服务
    openai_service = OpenAIHandler(
        openai_key=os.getenv("OPENAI_API_KEY"),
        openai_url=os.getenv("OPENAI_BASE_URL"),
        model="deepseek-chat"
    )
    
    # 读取输入数据
    inputs = read_inputs("datasets/dpo.txt")
    
    # 生成DPO数据
    dpo_data = await generate_dpo_data(inputs, openai_service, batch_size=1)
    
    # 打乱数据顺序后再保存
    import random
    random.shuffle(dpo_data)
    save_dpo_data(dpo_data, "datasets/lihuowang-alpaca-dpo.json")

if __name__ == "__main__":
    asyncio.run(main())
